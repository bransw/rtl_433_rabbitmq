# Makefile –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –æ–±—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ RTL433

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g -D_GNU_SOURCE
INCLUDES = -I../include -I../../include -I../../src
LIBS = -ljson-c -lm

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏)
SHARED_SOURCES = ../src/rtl433_signal.c ../src/rtl433_transport.c ../src/rtl433_config.c

# ASN.1 support detection
ASN1_BUILD_DIR = ../../build/shared/asn1-generated
ASN1_LIB_DIR = ../../build/shared
ASN1_AVAILABLE := $(shell [ -d "$(ASN1_BUILD_DIR)" ] && [ -f "$(ASN1_LIB_DIR)/librtl433_shared.a" ] && echo yes || echo no)

# –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
.PHONY: all clean test test-signal test-simple test-transport demo test-asn1

all: test_signal_simple test_signal_reconstruction simple_transport_example demo_real_data
ifeq ($(ASN1_AVAILABLE),yes)
	@echo "üîß ASN.1 support detected, also building ASN.1 test..."
	$(MAKE) test_asn1_encode_decode_pulses
endif

# –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
test_signal_simple: test_signal_simple.c
	@echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."
	$(CC) $(CFLAGS) -o $@ $< -ljson-c

# –¢–µ—Å—Ç —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
test_signal_reconstruction: test_signal_reconstruction.c
	@echo "üî® –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–∞ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤..."
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $< $(SHARED_SOURCES) $(LIBS)

# –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
simple_transport_example: simple_transport_example.c
	@echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–º–µ—Ä–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞..."
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $< $(SHARED_SOURCES) $(LIBS) -lrabbitmq

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
demo_real_data: demo_real_data.c
	@echo "üî® –°–±–æ—Ä–∫–∞ –¥–µ–º–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏..."
	$(CC) $(CFLAGS) -o $@ $< -ljson-c

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
test: test-simple

test-simple: test_signal_simple
	@echo "üß™ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."
	./test_signal_simple

test-signal: test_signal_reconstruction
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤..."
	./test_signal_reconstruction

test-transport: simple_transport_example
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (—Ç—Ä–µ–±—É–µ—Ç RabbitMQ)..."
	./simple_transport_example

demo: demo_real_data
	@echo "üé¨ –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏..."
	./demo_real_data

# ASN.1 test (requires shared library with ASN.1 support)
test_asn1_encode_decode_pulses: ../../test_asn1_encode_decode_pulses.c
ifeq ($(ASN1_AVAILABLE),yes)
	@echo "üî® –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–∞ ASN.1 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è..."
	$(CC) $(CFLAGS) -DENABLE_ASN1 \
		-I../include -I../../include -I$(ASN1_BUILD_DIR) \
		-o $@ $< \
		-L$(ASN1_LIB_DIR) -lrtl433_shared -L../../build/src -ldata $(LIBS)
else
	@echo "‚ö†Ô∏è  ASN.1 support not available. Build project with: cd ../../build && cmake -DENABLE_ASN1=ON .. && make"
endif

# Run ASN.1 test
test-asn1: test_asn1_encode_decode_pulses
ifeq ($(ASN1_AVAILABLE),yes)
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ ASN.1 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è..."
	./test_asn1_encode_decode_pulses
else
	@echo "‚ö†Ô∏è  ASN.1 test not available."
endif

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	rm -f test_signal_simple test_signal_reconstruction simple_transport_example demo_real_data test_asn1_encode_decode_pulses

# –°–ø—Ä–∞–≤–∫–∞
help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make all           - —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã –∏ –¥–µ–º–æ"
	@echo "  make test          - –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ—Å—Ç—ã"
	@echo "  make demo          - –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
	@echo "  make test-signal   - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"
	@echo "  make test-transport - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"
	@echo "  make test-asn1     - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç ASN.1 (—Ç—Ä–µ–±—É–µ—Ç ASN.1 –ø–æ–¥–¥–µ—Ä–∂–∫—É)"
	@echo "  make clean         - –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo ""
	@echo "ASN.1 Support Status: $(ASN1_AVAILABLE)"
ifeq ($(ASN1_AVAILABLE),no)
	@echo "  To enable ASN.1: cd ../../build && cmake -DENABLE_ASN1=ON .. && make"
endif
