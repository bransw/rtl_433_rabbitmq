# Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏ RTL_433 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–µ–∫–æ–≤
# 
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   make -f Makefile.dynamic          # –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
#   make -f Makefile.dynamic test     # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
#   make -f Makefile.dynamic clean    # –û—á–∏—Å—Ç–∫–∞
#   make -f Makefile.dynamic install  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -g
INCLUDES = -I./include -I./src
LIBS = -lm -lpthread
TARGET_DIR = build_dynamic

# –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
MAIN_TARGET = $(TARGET_DIR)/rtl_433_dynamic
LIB_TARGET = $(TARGET_DIR)/librtl433_dynamic.a
TEST_TARGET = $(TARGET_DIR)/test_dynamic_loading

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
DYNAMIC_SOURCES = src/dynamic_device_loader.c
CORE_SOURCES = src/r_api.c src/data.c src/list.c src/logger.c src/fatal.c \
               src/jsmn.c src/optparse.c src/devices/flex.c
MAIN_SOURCE = src/rtl_433_dynamic.c

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
DYNAMIC_OBJECTS = $(DYNAMIC_SOURCES:src/%.c=$(TARGET_DIR)/%.o)
CORE_OBJECTS = $(CORE_SOURCES:src/%.c=$(TARGET_DIR)/%.o)
MAIN_OBJECT = $(MAIN_SOURCE:src/%.c=$(TARGET_DIR)/%.o)

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
DIRS = $(TARGET_DIR) $(TARGET_DIR)/devices

# –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å
all: directories $(MAIN_TARGET)

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
directories:
	@mkdir -p $(DIRS)

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
$(LIB_TARGET): $(DYNAMIC_OBJECTS) $(CORE_OBJECTS)
	@echo "üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏..."
	ar rcs $@ $^
	@echo "‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: $@"

# –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
$(MAIN_TARGET): $(MAIN_OBJECT) $(LIB_TARGET)
	@echo "üîó –°–±–æ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞..."
	$(CC) $(CFLAGS) -o $@ $< -L$(TARGET_DIR) -lrtl433_dynamic $(LIBS)
	@echo "‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: $@"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(TARGET_DIR)/%.o: src/%.c
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è $<..."
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤
examples: directories
	@echo "üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤..."
	@mkdir -p $(TARGET_DIR)/devices
	@cp -r examples/dynamic_devices/* $(TARGET_DIR)/devices/ 2>/dev/null || true
	@echo "‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ $(TARGET_DIR)/devices/"

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: $(MAIN_TARGET) examples
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
	python3 test_dynamic_loading.py --binary $(MAIN_TARGET) --create-examples
	@echo "üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–º–µ—Ä–æ–≤..."
	$(MAIN_TARGET) -D $(TARGET_DIR)/devices -L
	@echo "‚úÖ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

# –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤
quick-test: $(MAIN_TARGET)
	@echo "‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç..."
	python3 test_dynamic_loading.py --binary $(MAIN_TARGET)

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
demo: $(MAIN_TARGET) examples
	@echo "üé¨ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏..."
	@echo ""
	@echo "1Ô∏è‚É£  –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É:"
	$(MAIN_TARGET) -h | head -20
	@echo ""
	@echo "2Ô∏è‚É£  –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–¥–µ–∫–∏:"
	$(MAIN_TARGET) -D $(TARGET_DIR)/devices -L
	@echo ""
	@echo "3Ô∏è‚É£  –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª:"
	$(MAIN_TARGET) -J $(TARGET_DIR)/devices/temperature_sensor.json -L

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
install: $(MAIN_TARGET)
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ RTL_433 —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π..."
	sudo cp $(MAIN_TARGET) /usr/local/bin/
	sudo mkdir -p /usr/local/share/rtl433/devices
	sudo cp examples/dynamic_devices/* /usr/local/share/rtl433/devices/ 2>/dev/null || true
	@echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
	@echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: rtl_433_dynamic -D /usr/local/share/rtl433/devices -L"

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
package: $(MAIN_TARGET) examples
	@echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è..."
	@mkdir -p package/rtl433_dynamic
	@cp $(MAIN_TARGET) package/rtl433_dynamic/
	@cp -r $(TARGET_DIR)/devices package/rtl433_dynamic/
	@cp DYNAMIC_DEVICE_LOADING.md package/rtl433_dynamic/README.md
	@cp test_dynamic_loading.py package/rtl433_dynamic/
	@echo "#!/bin/bash" > package/rtl433_dynamic/run_demo.sh
	@echo "cd \$$(dirname \$$0)" >> package/rtl433_dynamic/run_demo.sh
	@echo "./rtl_433_dynamic -D ./devices -L" >> package/rtl433_dynamic/run_demo.sh
	@chmod +x package/rtl433_dynamic/run_demo.sh
	@tar -czf rtl433_dynamic_package.tar.gz -C package rtl433_dynamic
	@echo "‚úÖ –ü–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω: rtl433_dynamic_package.tar.gz"

# –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞
debug: CFLAGS += -DDEBUG -g3 -O0
debug: clean $(MAIN_TARGET)
	@echo "üêõ –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
profile: CFLAGS += -pg -fprofile-arcs -ftest-coverage
profile: LIBS += -lgcov
profile: clean $(MAIN_TARGET)
	@echo "üìä –°–±–æ—Ä–∫–∞ —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
analyze:
	@echo "üîç –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞..."
	@which cppcheck >/dev/null 2>&1 && cppcheck --enable=all --std=c99 src/ include/ || echo "cppcheck –Ω–µ –Ω–∞–π–¥–µ–Ω"
	@which clang-tidy >/dev/null 2>&1 && clang-tidy src/*.c -- $(INCLUDES) || echo "clang-tidy –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
format:
	@echo "üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
	@which clang-format >/dev/null 2>&1 && find src include -name "*.c" -o -name "*.h" | xargs clang-format -i || echo "clang-format –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check-deps:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä GCC: $$(which gcc 2>/dev/null && echo '‚úÖ' || echo '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω')"
	@echo "Python 3: $$(which python3 2>/dev/null && echo '‚úÖ' || echo '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω')"
	@echo "Make: $$(which make 2>/dev/null && echo '‚úÖ' || echo '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω')"
	@echo "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞: $$(echo '#include <math.h>' | gcc -x c -E - >/dev/null 2>&1 && echo '‚úÖ' || echo '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞')"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å–±–æ—Ä–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	rm -rf $(TARGET_DIR)
	rm -rf package
	rm -f rtl433_dynamic_package.tar.gz
	rm -f devices/*.json devices/*.ini devices/*.conf 2>/dev/null || true
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ü–æ–º–æ—â—å
help:
	@echo "üéØ RTL_433 —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–æ–¥–µ–∫–æ–≤"
	@echo "=============================================="
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make -f Makefile.dynamic              # –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"
	@echo "  make -f Makefile.dynamic test         # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"
	@echo "  make -f Makefile.dynamic demo         # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã"
	@echo "  make -f Makefile.dynamic examples     # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤"
	@echo "  make -f Makefile.dynamic install      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ —Å–∏—Å—Ç–µ–º—É"
	@echo "  make -f Makefile.dynamic package      # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞"
	@echo "  make -f Makefile.dynamic debug        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞"
	@echo "  make -f Makefile.dynamic analyze      # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"
	@echo "  make -f Makefile.dynamic format       # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
	@echo "  make -f Makefile.dynamic check-deps   # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
	@echo "  make -f Makefile.dynamic clean        # –û—á–∏—Å—Ç–∫–∞"
	@echo "  make -f Makefile.dynamic help         # –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
	@echo ""
	@echo "–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:"
	@echo "  ./$(MAIN_TARGET) -D ./devices -L      # –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥–µ–∫–∏"
	@echo "  ./$(MAIN_TARGET) -J device.json       # –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª"
	@echo "  ./$(MAIN_TARGET) -H                   # –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
info:
	@echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ"
	@echo "======================"
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CC)"
	@echo "–§–ª–∞–≥–∏: $(CFLAGS)"
	@echo "–í–∫–ª—é—á–µ–Ω–∏—è: $(INCLUDES)"
	@echo "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: $(LIBS)"
	@echo "–¶–µ–ª–µ–≤–∞—è –ø–∞–ø–∫–∞: $(TARGET_DIR)"
	@echo "–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å: $(MAIN_TARGET)"

# –ü—Å–µ–≤–¥–æ—Ü–µ–ª–∏
.PHONY: all directories examples test quick-test demo install package debug profile analyze format check-deps clean help info

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(TARGET_DIR)/dynamic_device_loader.o: include/dynamic_device_loader.h include/r_device.h
$(TARGET_DIR)/rtl_433_dynamic.o: include/dynamic_device_loader.h src/rtl_433.c
